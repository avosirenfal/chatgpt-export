// ==UserScript==
// @name           ChatGPT save button
// @author         Sirenfal
// @description    Adds save button.
// @namespace      sirenfal
// @version        1.0.0
// @match          https://chat.openai.com/*
// @grant          none
// @run-at         document-start
// ==/UserScript==

(function() {
	'use strict';

	// I hate javascript
	function b64DecodeUnicode(str) {
		return decodeURIComponent(atob(str).split('').map(function(c) {
			return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
		}).join(''));
	}

	const HTML_TEMPLATE = b64DecodeUnicode(`PGh0bWw+CiAgPGhlYWQ+CiAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgoJYm9keXsKCQliYWNrZ3JvdW5kOiAjMDAwOwoJCW1hcmdpbjogMDsKCX0KCS5yZXBsaWVzewoJCW1heC13aWR0aDogNzVjaDsKCQlkaXNwbGF5OiBmbGV4OwoJCWZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CgkJYWxpZ24taXRlbXM6IGNlbnRlcjsKCQlqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKCQltYXJnaW46IDAgYXV0bzsKCQlmb250LWZhbWlseTogU8O2aG5lLHVpLXNhbnMtc2VyaWYsc3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLFVidW50dSxDYW50YXJlbGwsTm90byBTYW5zLHNhbnMtc2VyaWYsSGVsdmV0aWNhIE5ldWUsQXJpYWwsQXBwbGUgQ29sb3IgRW1vamksU2Vnb2UgVUkgRW1vamksU2Vnb2UgVUkgU3ltYm9sLE5vdG8gQ29sb3IgRW1vamk7CgkJZm9udC1zaXplOiAxNnB4OwoJCWNvbG9yOiAjZDFkNWRiOwoJCXRhYi1zaXplOiA0OwoJCS13ZWJraXQtdGV4dC1zaXplLWFkanVzdDogMTAwJTsKCX0KCS5yZXBsaWVzID4gKiB7CgkJd2lkdGg6IDEwMCU7CgkJZmxleDogMTsKCQkvKiBmb3Igc29tZSByZWFzb24gb24gdGhlIG9mZmljaWFsCgkJY2hhdCBHUFQgc2l0ZSB0aGUgYm90dG9tIGhhcyBhIG1hcmdpbgoJCXN0YWNrZWQgd2l0aCBwYWRkaW5nLCBzbyBpdCdzIDI0cHggb24KCQl0b3AgYW5kIDM3cHggb24gYm90dG9tICovCgkJcGFkZGluZzogMjRweCAxMnJlbSAzN3B4IDEycmVtOwoJCS8qCgkJdGhlIE9wZW5BSSBTVkcgaXMgYWJzb2x1dGVseSBwb3NpdGlvbmVkCgkJc28gbWFrZSBzdXJlIHRoaXMgaGFzIGEgbWluLWhlaWdodCBpbiB0aGUKCQljYXNlIG9mIHNpbmdsZSBsaW5lIHJlc3BvbnNlcwoJCSovCgkJbWluLWhlaWdodDogMjRweDsKCQlsaW5lLWhlaWdodDogMjRweDsKCX0KCQoJLnJlcGxpZXMgb2wgbGksIC5yZXBsaWVzIG9sIHVsIHsKCQltYXJnaW46IDAuNWV4OwoJfQoJCgkucmVwbGllcyBvbCBsaTo6bWFya2VyIHsKCQljb2xvcjogcmdiKDE1NiwgMTYzLCAxNzUpOwoJCWZvbnQtd2VpZ2h0OiA0MDA7Cgl9CgkKCS5yZXBsaWVzID4gLnVzZXJ7CgkJcG9zaXRpb246IHJlbGF0aXZlOwoJCWJhY2tncm91bmQ6IHJnYmEoNTIsNTMsNjUpOwoJfQoJLnJlcGxpZXMgPiAuZ3B0ewoJCXBvc2l0aW9uOiByZWxhdGl2ZTsKCQliYWNrZ3JvdW5kOiByZ2JhKDY4LDcwLDg0KTsKCX0KCQoJKiA+IHA6Zmlyc3QtY2hpbGQgewoJCW1hcmdpbi10b3A6IDA7Cgl9CgkKCSogPiBwOmxhc3QtY2hpbGQgewoJCW1hcmdpbi1ib3R0b206IDA7Cgl9CgkKCS5yZXBsaWVzID4gKjo6YmVmb3JlIHsKCQlkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CgkJd2lkdGg6IDIxcHg7CgkJaGVpZ2h0OiAyMXB4OwoJCXBhZGRpbmc6IDQuNXB4OwoJCWJhY2tncm91bmQ6ICMxMGEzN2Y7CgkJYm9yZGVyLXJhZGl1czogMnB4OwoJCXBvc2l0aW9uOiBhYnNvbHV0ZTsKCQkvKiB0aGUgc2FtZSB0b3AgcGFkZGluZyBhcyBgLnJlcGxpZXMgPiAqYCAqLwoJCW1hcmdpbi10b3A6IDI0cHg7CgkJdG9wOiAwOwoJCS8qIHNsaWdodGx5IGxlc3MgdGhhbiBoYWxmIHRoZSBzaWRlIHBhZGRpbmcKCQlvZiBgLnJlcGxpZXMgPiAqYCAqLwoJCWxlZnQ6IDhyZW07CgkJY29udGVudDogJyc7Cgl9CgkKCS5yZXBsaWVzID4gLnVzZXI6OmJlZm9yZSB7CgkJZGlzcGxheTogaW5saW5lLWZsZXg7CgkJYWxpZ24taXRlbXM6IGNlbnRlcjsKCQlqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKCQliYWNrZ3JvdW5kOiAjMDA4OGNmOwoJCWNvbnRlbnQ6ICdLJzsKCQlmb250LXNpemU6IDEuMXJlbTsKCX0KCQoJLnJlcGxpZXMgPiAuZ3B0OjpiZWZvcmUgewoJCWNvbnRlbnQ6IHVybCgnZGF0YTppbWFnZS9zdmcreG1sO3V0ZjgsPHN2ZyB2aWV3Qm94PSIwIDAgNDEgNDEiIHN0cm9rZVdpZHRoPSIxLjUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTM3LjUzMjQgMTYuODcwN0MzNy45ODA4IDE1LjUyNDEgMzguMTM2MyAxNC4wOTc0IDM3Ljk4ODYgMTIuNjg1OUMzNy44NDA5IDExLjI3NDQgMzcuMzkzNCA5LjkxMDc2IDM2LjY3NiA4LjY4NjIyQzM1LjYxMjYgNi44MzQwNCAzMy45ODgyIDUuMzY3NiAzMi4wMzczIDQuNDk4NUMzMC4wODY0IDMuNjI5NDEgMjcuOTA5OCAzLjQwMjU5IDI1LjgyMTUgMy44NTA3OEMyNC44Nzk2IDIuNzg5MyAyMy43MjE5IDEuOTQxMjUgMjIuNDI1NyAxLjM2MzQxQzIxLjEyOTUgMC43ODU1NzUgMTkuNzI0OSAwLjQ5MTI2OSAxOC4zMDU4IDAuNTAwMTk3QzE2LjE3MDggMC40OTUwNDQgMTQuMDg5MyAxLjE2ODAzIDEyLjM2MTQgMi40MjIxNEMxMC42MzM1IDMuNjc2MjQgOS4zNDg1MyA1LjQ0NjY2IDguNjkxNyA3LjQ3ODE1QzcuMzAwODUgNy43NjI4NiA1Ljk4Njg2IDguMzQxNCA0LjgzNzcgOS4xNzUwNUMzLjY4ODU0IDEwLjAwODcgMi43MzA3MyAxMS4wNzgyIDIuMDI4MzkgMTIuMzEyQzAuOTU2NDY0IDE0LjE1OTEgMC40OTg5MDUgMTYuMjk4OCAwLjcyMTY5OCAxOC40MjI4QzAuOTQ0NDkyIDIwLjU0NjcgMS44MzYxMiAyMi41NDQ5IDMuMjY4IDI0LjEyOTNDMi44MTk2NiAyNS40NzU5IDIuNjY0MTMgMjYuOTAyNiAyLjgxMTgyIDI4LjMxNDFDMi45NTk1MSAyOS43MjU2IDMuNDA3MDEgMzEuMDg5MiA0LjEyNDM3IDMyLjMxMzhDNS4xODc5MSAzNC4xNjU5IDYuODEyMyAzNS42MzIyIDguNzYzMjEgMzYuNTAxM0MxMC43MTQxIDM3LjM3MDQgMTIuODkwNyAzNy41OTczIDE0Ljk3ODkgMzcuMTQ5MkMxNS45MjA4IDM4LjIxMDcgMTcuMDc4NiAzOS4wNTg3IDE4LjM3NDcgMzkuNjM2NkMxOS42NzA5IDQwLjIxNDQgMjEuMDc1NSA0MC41MDg3IDIyLjQ5NDYgNDAuNDk5OEMyNC42MzA3IDQwLjUwNTQgMjYuNzEzMyAzOS44MzIxIDI4LjQ0MTggMzguNTc3MkMzMC4xNzA0IDM3LjMyMjMgMzEuNDU1NiAzNS41NTA2IDMyLjExMTkgMzMuNTE3OUMzMy41MDI3IDMzLjIzMzIgMzQuODE2NyAzMi42NTQ3IDM1Ljk2NTkgMzEuODIxQzM3LjExNSAzMC45ODc0IDM4LjA3MjggMjkuOTE3OCAzOC43NzUyIDI4LjY4NEMzOS44NDU4IDI2LjgzNzEgNDAuMzAyMyAyNC42OTc5IDQwLjA3ODkgMjIuNTc0OEMzOS44NTU2IDIwLjQ1MTcgMzguOTYzOSAxOC40NTQ0IDM3LjUzMjQgMTYuODcwN1pNMjIuNDk3OCAzNy44ODQ5QzIwLjc0NDMgMzcuODg3NCAxOS4wNDU5IDM3LjI3MzMgMTcuNjk5NCAzNi4xNTAxQzE3Ljc2MDEgMzYuMTE3IDE3Ljg2NjYgMzYuMDU4NiAxNy45MzYgMzYuMDE2MUwyNS45MDA0IDMxLjQxNTZDMjYuMTAwMyAzMS4zMDE5IDI2LjI2NjMgMzEuMTM3IDI2LjM4MTMgMzAuOTM3OEMyNi40OTY0IDMwLjczODYgMjYuNTU2MyAzMC41MTI0IDI2LjU1NDkgMzAuMjgyNVYxOS4wNTQyTDI5LjkyMTMgMjAuOTk4QzI5LjkzODkgMjEuMDA2OCAyOS45NTQxIDIxLjAxOTggMjkuOTY1NiAyMS4wMzU5QzI5Ljk3NyAyMS4wNTIgMjkuOTg0MiAyMS4wNzA3IDI5Ljk4NjcgMjEuMDkwMlYzMC4zODg5QzI5Ljk4NDIgMzIuMzc1IDI5LjE5NDYgMzQuMjc5MSAyNy43OTA5IDM1LjY4NDFDMjYuMzg3MiAzNy4wODkyIDI0LjQ4MzggMzcuODgwNiAyMi40OTc4IDM3Ljg4NDlaTTYuMzkyMjcgMzEuMDA2NEM1LjUxMzk3IDI5LjQ4ODggNS4xOTc0MiAyNy43MTA3IDUuNDk4MDQgMjUuOTgzMkM1LjU1NzE4IDI2LjAxODcgNS42NjA0OCAyNi4wODE4IDUuNzM0NjEgMjYuMTI0NEwxMy42OTkgMzAuNzI0OEMxMy44OTc1IDMwLjg0MDggMTQuMTIzMyAzMC45MDIgMTQuMzUzMiAzMC45MDJDMTQuNTgzIDMwLjkwMiAxNC44MDg4IDMwLjg0MDggMTUuMDA3MyAzMC43MjQ4TDI0LjczMSAyNS4xMTAzVjI4Ljk5NzlDMjQuNzMyMSAyOS4wMTc3IDI0LjcyODMgMjkuMDM3NiAyNC43MTk5IDI5LjA1NTZDMjQuNzExNSAyOS4wNzM2IDI0LjY5ODggMjkuMDg5MyAyNC42ODI5IDI5LjEwMTJMMTYuNjMxNyAzMy43NDk3QzE0LjkwOTYgMzQuNzQxNiAxMi44NjQzIDM1LjAwOTcgMTAuOTQ0NyAzNC40OTU0QzkuMDI1MDYgMzMuOTgxMSA3LjM4Nzg1IDMyLjcyNjMgNi4zOTIyNyAzMS4wMDY0Wk00LjI5NzA3IDEzLjYxOTRDNS4xNzE1NiAxMi4wOTk4IDYuNTUyNzkgMTAuOTM2NCA4LjE5ODg1IDEwLjMzMjdDOC4xOTg4NSAxMC40MDEzIDguMTk0OTEgMTAuNTIyOCA4LjE5NDkxIDEwLjYwNzFWMTkuODA4QzguMTkzNTEgMjAuMDM3OCA4LjI1MzM0IDIwLjI2MzggOC4zNjgyMyAyMC40NjI5QzguNDgzMTIgMjAuNjYxOSA4LjY0ODkzIDIwLjgyNjcgOC44NDg2MyAyMC45NDA0TDE4LjU3MjMgMjYuNTU0MkwxNS4yMDYgMjguNDk3OUMxNS4xODk0IDI4LjUwODkgMTUuMTcwMyAyOC41MTU1IDE1LjE1MDUgMjguNTE3M0MxNS4xMzA3IDI4LjUxOTEgMTUuMTEwNyAyOC41MTYgMTUuMDkyNCAyOC41MDgyTDcuMDQwNDYgMjMuODU1N0M1LjMyMTM1IDIyLjg2MDEgNC4wNjcxNiAyMS4yMjM1IDMuNTUyODkgMTkuMzA0NkMzLjAzODYyIDE3LjM4NTggMy4zMDYyNCAxNS4zNDEzIDQuMjk3MDcgMTMuNjE5NFpNMzEuOTU1IDIwLjA1NTZMMjIuMjMxMiAxNC40NDExTDI1LjU5NzYgMTIuNDk4MUMyNS42MTQyIDEyLjQ4NzIgMjUuNjMzMyAxMi40ODA1IDI1LjY1MzEgMTIuNDc4N0MyNS42NzI5IDEyLjQ3NjkgMjUuNjkyOCAxMi40ODAxIDI1LjcxMTEgMTIuNDg3OUwzMy43NjMxIDE3LjEzNjRDMzQuOTk2NyAxNy44NDkgMzYuMDAxNyAxOC44OTgyIDM2LjY2MDYgMjAuMTYxM0MzNy4zMTk0IDIxLjQyNDQgMzcuNjA0NyAyMi44NDkgMzcuNDgzMiAyNC4yNjg0QzM3LjM2MTcgMjUuNjg3OCAzNi44MzgyIDI3LjA0MzIgMzUuOTc0MyAyOC4xNzU5QzM1LjExMDMgMjkuMzA4NiAzMy45NDE1IDMwLjE3MTcgMzIuNjA0NyAzMC42NjQxQzMyLjYwNDcgMzAuNTk0NyAzMi42MDQ3IDMwLjQ3MzMgMzIuNjA0NyAzMC4zODg5VjIxLjE4OEMzMi42MDY2IDIwLjk1ODYgMzIuNTQ3NCAyMC43MzI4IDMyLjQzMzIgMjAuNTMzOEMzMi4zMTkgMjAuMzM0OCAzMi4xNTQgMjAuMTY5OCAzMS45NTUgMjAuMDU1NlpNMzUuMzA1NSAxNS4wMTI4QzM1LjI0NjQgMTQuOTc2NSAzNS4xNDMxIDE0LjkxNDIgMzUuMDY5IDE0Ljg3MTdMMjcuMTA0NSAxMC4yNzEyQzI2LjkwNiAxMC4xNTU0IDI2LjY4MDMgMTAuMDk0MyAyNi40NTA0IDEwLjA5NDNDMjYuMjIwNiAxMC4wOTQzIDI1Ljk5NDggMTAuMTU1NCAyNS43OTYzIDEwLjI3MTJMMTYuMDcyNiAxNS44ODU4VjExLjk5ODJDMTYuMDcxNSAxMS45NzgzIDE2LjA3NTMgMTEuOTU4NSAxNi4wODM3IDExLjk0MDVDMTYuMDkyMSAxMS45MjI1IDE2LjEwNDggMTEuOTA2OCAxNi4xMjA3IDExLjg5NDlMMjQuMTcxOSA3LjI1MDI1QzI1LjQwNTMgNi41MzkwMyAyNi44MTU4IDYuMTkzNzYgMjguMjM4MyA2LjI1NDgyQzI5LjY2MDggNi4zMTU4OSAzMS4wMzY0IDYuNzgwNzcgMzIuMjA0NCA3LjU5NTA4QzMzLjM3MjMgOC40MDkzOSAzNC4yODQyIDkuNTM5NDUgMzQuODMzNCAxMC44NTMxQzM1LjM4MjYgMTIuMTY2NyAzNS41NDY0IDEzLjYwOTUgMzUuMzA1NSAxNS4wMTI4Wk0xNC4yNDI0IDIxLjk0MTlMMTAuODc1MiAxOS45OTgxQzEwLjg1NzYgMTkuOTg5MyAxMC44NDIzIDE5Ljk3NjMgMTAuODMwOSAxOS45NjAyQzEwLjgxOTUgMTkuOTQ0MSAxMC44MTIyIDE5LjkyNTQgMTAuODA5OCAxOS45MDU4VjEwLjYwNzFDMTAuODEwNyA5LjE4Mjk1IDExLjIxNzMgNy43ODg0OCAxMS45ODE5IDYuNTg2OTZDMTIuNzQ2NiA1LjM4NTQ0IDEzLjgzNzcgNC40MjY1OSAxNS4xMjc1IDMuODIyNjRDMTYuNDE3MyAzLjIxODY5IDE3Ljg1MjQgMi45OTQ2NCAxOS4yNjQ5IDMuMTc2N0MyMC42Nzc1IDMuMzU4NzYgMjIuMDA4OSAzLjkzOTQxIDIzLjEwMzQgNC44NTA2N0MyMy4wNDI3IDQuODgzNzkgMjIuOTM3IDQuOTQyMTUgMjIuODY2OCA0Ljk4NDczTDE0LjkwMjQgOS41ODUxN0MxNC43MDI1IDkuNjk4NzggMTQuNTM2NiA5Ljg2MzU2IDE0LjQyMTUgMTAuMDYyNkMxNC4zMDY1IDEwLjI2MTYgMTQuMjQ2NiAxMC40ODc3IDE0LjI0NzkgMTAuNzE3NUwxNC4yNDI0IDIxLjk0MTlaTTE2LjA3MSAxNy45OTkxTDIwLjQwMTggMTUuNDk3OEwyNC43MzI1IDE3Ljk5NzVWMjIuOTk4NUwyMC40MDE4IDI1LjQ5ODNMMTYuMDcxIDIyLjk5ODVWMTcuOTk5MVoiIGZpbGw9IndoaXRlIj48L3BhdGg+PC9zdmc+Jyk7Cgl9Cgk8L3N0eWxlPgogIDwvaGVhZD4KICA8Ym9keT4KICAgIDxkaXYgY2xhc3M9InJlcGxpZXMiPgoJCTwhLS0gSU5TRVJUIEhFUkUgLS0+CiAgICA8L2Rpdj4KICA8L2JvZHk+CjwvaHRtbD4=`);
	const HTML_MARKER = `<!-- INSERT HERE -->`;

	async function sha1Hash(stringToHash) {
		const encoder = new TextEncoder();
		const dataToHash = encoder.encode(stringToHash);

		const crypto = window.crypto || window.msCrypto; // for IE 11
		const subtle = crypto.subtle;
		const hashAlgorithm = "SHA-1";

		const hashedData = await subtle.digest(hashAlgorithm, dataToHash);

		// Convert the hashed data to a hexadecimal string
		const hashedHexString = Array.from(new Uint8Array(hashedData))
			.map((b) => b.toString(16).padStart(2, "0"))
			.join("");

		return hashedHexString;
	}

	function makeHTML(contents) {
		return HTML_TEMPLATE.replace(HTML_MARKER, contents);
	}

	// uses a MutationObserver to catch React re-renders
	const callback = function(mutationsList, observer) {
		const nav = document.querySelector("nav");

		if(Array.from(nav.querySelectorAll("#custom_save_button")).length > 0)
			return;

		const el = nav.lastElementChild.cloneNode(false);
		el.id = 'custom_save_button';
		el.innerHTML = "Save Chat";

		el.onclick = async function() {
			const a = document.createElement('a');
			const contents = Array.from(document.querySelectorAll(".text-base")).map(
				item => {
					const isGPT = Array.from(item.querySelectorAll('button')).length >= 2;
					//const isGPT = item.querySelector(`div[class^="request-"]`) !== null
					const contents = item.querySelector(`.items-start`)

					if(contents === null) {
						return null;
					}

					return `<div class="${isGPT ? "gpt" : "user"}">${contents.innerHTML}</div>`
				}
			);

			for(const item of contents) {
				if(item === null) {
					alert("Failed to get text for all items, check your CSS selector :(");
					return;
				}
			}

			a.href = URL.createObjectURL(new Blob([makeHTML(contents.join("\n"))], {
				type: 'text/html'
			}));
			const hash = await sha1Hash(contents[0]);
			a.download = `gpt_${hash}.html`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(a.href);
		}

		nav.appendChild(el);
	};

	window.addEventListener('load', (event) => {
		const observer = new MutationObserver(callback);
		observer.observe(document.querySelector('body'), { attributes: true, childList: true, subtree: true });
	});
})();