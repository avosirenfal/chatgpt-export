// ==UserScript==
// @name          ChatGPT save button
// @author        Sirenfal
// @description   Adds save button.
// @namespace     sirenfal
// @version       1.0.1
// @match         https://chat.openai.com/*
// @grant         none
// @run-at        document-start
// ==/UserScript==

(function() {
	'use strict';

    // I hate javascript
    function b64DecodeUnicode(str) {
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    }

    const HTML_TEMPLATE = b64DecodeUnicode(`PGh0bWw+CiAgPGhlYWQ+Cgk8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgoJYm9keXsKCQliYWNrZ3JvdW5kOiAjMDAwOwoJCW1hcmdpbjogMDsKCX0KCS5yZXBsaWVzewoJCW1heC13aWR0aDogNzVjaDsKCQlkaXNwbGF5OiBmbGV4OwoJCWZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CgkJYWxpZ24taXRlbXM6IGNlbnRlcjsKCQlqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKCQltYXJnaW46IDAgYXV0bzsKCQlmb250LWZhbWlseTogU8O2aG5lLHVpLXNhbnMtc2VyaWYsc3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLFVidW50dSxDYW50YXJlbGwsTm90byBTYW5zLHNhbnMtc2VyaWYsSGVsdmV0aWNhIE5ldWUsQXJpYWwsQXBwbGUgQ29sb3IgRW1vamksU2Vnb2UgVUkgRW1vamksU2Vnb2UgVUkgU3ltYm9sLE5vdG8gQ29sb3IgRW1vamk7CgkJZm9udC1zaXplOiAxNnB4OwoJCWNvbG9yOiAjZDFkNWRiOwoJCXRhYi1zaXplOiA0OwoJCS13ZWJraXQtdGV4dC1zaXplLWFkanVzdDogMTAwJTsKCX0KCS5yZXBsaWVzID4gKiB7CgkJd2lkdGg6IDEwMCU7CgkJZmxleDogMTsKCQkvKiBmb3Igc29tZSByZWFzb24gb24gdGhlIG9mZmljaWFsCgkJY2hhdCBHUFQgc2l0ZSB0aGUgYm90dG9tIGhhcyBhIG1hcmdpbgoJCXN0YWNrZWQgd2l0aCBwYWRkaW5nLCBzbyBpdCdzIDI0cHggb24KCQl0b3AgYW5kIDM3cHggb24gYm90dG9tICovCgkJcGFkZGluZzogMjRweCAxMnJlbSAzN3B4IDEycmVtOwoJCS8qCgkJdGhlIE9wZW5BSSBTVkcgaXMgYWJzb2x1dGVseSBwb3NpdGlvbmVkCgkJc28gbWFrZSBzdXJlIHRoaXMgaGFzIGEgbWluLWhlaWdodCBpbiB0aGUKCQljYXNlIG9mIHNpbmdsZSBsaW5lIHJlc3BvbnNlcwoJCSovCgkJbWluLWhlaWdodDogMjRweDsKCQlsaW5lLWhlaWdodDogMjRweDsKCQkKCX0KCQoJLnJlcGxpZXMgb2wgbGksIC5yZXBsaWVzIG9sIHVsIHsKCQltYXJnaW46IDAuNWV4OwoJfQoJCgkucmVwbGllcyBvbCBsaTo6bWFya2VyIHsKCQljb2xvcjogcmdiKDE1NiwgMTYzLCAxNzUpOwoJCWZvbnQtd2VpZ2h0OiA0MDA7Cgl9CgkKCS5yZXBsaWVzID4gLnVzZXJ7CgkJcG9zaXRpb246IHJlbGF0aXZlOwoJCWJhY2tncm91bmQ6IHJnYmEoNTIsNTMsNjUpOwoJfQoJLnJlcGxpZXMgPiAuZ3B0ewoJCXBvc2l0aW9uOiByZWxhdGl2ZTsKCQliYWNrZ3JvdW5kOiByZ2JhKDY4LDcwLDg0KTsKCX0KCQoJKiA+IHA6Zmlyc3QtY2hpbGQgewoJCW1hcmdpbi10b3A6IDA7Cgl9CgkKCSogPiBwOmxhc3QtY2hpbGQgewoJCW1hcmdpbi1ib3R0b206IDA7Cgl9CgkKCS5yZXBsaWVzID4gKjo6YmVmb3JlIHsKCQlkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CgkJd2lkdGg6IDIxcHg7CgkJaGVpZ2h0OiAyMXB4OwoJCXBhZGRpbmc6IDQuNXB4OwoJCWJhY2tncm91bmQ6ICMxMGEzN2Y7CgkJYm9yZGVyLXJhZGl1czogMnB4OwoJCXBvc2l0aW9uOiBhYnNvbHV0ZTsKCQkvKiB0aGUgc2FtZSB0b3AgcGFkZGluZyBhcyBgLnJlcGxpZXMgPiAqYCAqLwoJCW1hcmdpbi10b3A6IDI0cHg7CgkJdG9wOiAwOwoJCS8qIHNsaWdodGx5IGxlc3MgdGhhbiBoYWxmIHRoZSBzaWRlIHBhZGRpbmcKCQlvZiBgLnJlcGxpZXMgPiAqYCAqLwoJCWxlZnQ6IDhyZW07CgkJY29udGVudDogJyc7Cgl9CgkKCS5yZXBsaWVzID4gLnVzZXI6OmJlZm9yZSB7CgkJZGlzcGxheTogaW5saW5lLWZsZXg7CgkJYWxpZ24taXRlbXM6IGNlbnRlcjsKCQlqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKCQliYWNrZ3JvdW5kOiAjMDA4OGNmOwoJCWNvbnRlbnQ6ICdLJzsKCQlmb250LXNpemU6IDEuMXJlbTsKCX0KCQoJLnJlcGxpZXMgPiAuZ3B0OjpiZWZvcmUgewoJCWNvbnRlbnQ6IHVybCgnZGF0YTppbWFnZS9zdmcreG1sO3V0ZjgsPHN2ZyB2aWV3Qm94PSIwIDAgNDEgNDEiIHN0cm9rZVdpZHRoPSIxLjUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTM3LjUzMjQgMTYuODcwN0MzNy45ODA4IDE1LjUyNDEgMzguMTM2MyAxNC4wOTc0IDM3Ljk4ODYgMTIuNjg1OUMzNy44NDA5IDExLjI3NDQgMzcuMzkzNCA5LjkxMDc2IDM2LjY3NiA4LjY4NjIyQzM1LjYxMjYgNi44MzQwNCAzMy45ODgyIDUuMzY3NiAzMi4wMzczIDQuNDk4NUMzMC4wODY0IDMuNjI5NDEgMjcuOTA5OCAzLjQwMjU5IDI1LjgyMTUgMy44NTA3OEMyNC44Nzk2IDIuNzg5MyAyMy43MjE5IDEuOTQxMjUgMjIuNDI1NyAxLjM2MzQxQzIxLjEyOTUgMC43ODU1NzUgMTkuNzI0OSAwLjQ5MTI2OSAxOC4zMDU4IDAuNTAwMTk3QzE2LjE3MDggMC40OTUwNDQgMTQuMDg5MyAxLjE2ODAzIDEyLjM2MTQgMi40MjIxNEMxMC42MzM1IDMuNjc2MjQgOS4zNDg1MyA1LjQ0NjY2IDguNjkxNyA3LjQ3ODE1QzcuMzAwODUgNy43NjI4NiA1Ljk4Njg2IDguMzQxNCA0LjgzNzcgOS4xNzUwNUMzLjY4ODU0IDEwLjAwODcgMi43MzA3MyAxMS4wNzgyIDIuMDI4MzkgMTIuMzEyQzAuOTU2NDY0IDE0LjE1OTEgMC40OTg5MDUgMTYuMjk4OCAwLjcyMTY5OCAxOC40MjI4QzAuOTQ0NDkyIDIwLjU0NjcgMS44MzYxMiAyMi41NDQ5IDMuMjY4IDI0LjEyOTNDMi44MTk2NiAyNS40NzU5IDIuNjY0MTMgMjYuOTAyNiAyLjgxMTgyIDI4LjMxNDFDMi45NTk1MSAyOS43MjU2IDMuNDA3MDEgMzEuMDg5MiA0LjEyNDM3IDMyLjMxMzhDNS4xODc5MSAzNC4xNjU5IDYuODEyMyAzNS42MzIyIDguNzYzMjEgMzYuNTAxM0MxMC43MTQxIDM3LjM3MDQgMTIuODkwNyAzNy41OTczIDE0Ljk3ODkgMzcuMTQ5MkMxNS45MjA4IDM4LjIxMDcgMTcuMDc4NiAzOS4wNTg3IDE4LjM3NDcgMzkuNjM2NkMxOS42NzA5IDQwLjIxNDQgMjEuMDc1NSA0MC41MDg3IDIyLjQ5NDYgNDAuNDk5OEMyNC42MzA3IDQwLjUwNTQgMjYuNzEzMyAzOS44MzIxIDI4LjQ0MTggMzguNTc3MkMzMC4xNzA0IDM3LjMyMjMgMzEuNDU1NiAzNS41NTA2IDMyLjExMTkgMzMuNTE3OUMzMy41MDI3IDMzLjIzMzIgMzQuODE2NyAzMi42NTQ3IDM1Ljk2NTkgMzEuODIxQzM3LjExNSAzMC45ODc0IDM4LjA3MjggMjkuOTE3OCAzOC43NzUyIDI4LjY4NEMzOS44NDU4IDI2LjgzNzEgNDAuMzAyMyAyNC42OTc5IDQwLjA3ODkgMjIuNTc0OEMzOS44NTU2IDIwLjQ1MTcgMzguOTYzOSAxOC40NTQ0IDM3LjUzMjQgMTYuODcwN1pNMjIuNDk3OCAzNy44ODQ5QzIwLjc0NDMgMzcuODg3NCAxOS4wNDU5IDM3LjI3MzMgMTcuNjk5NCAzNi4xNTAxQzE3Ljc2MDEgMzYuMTE3IDE3Ljg2NjYgMzYuMDU4NiAxNy45MzYgMzYuMDE2MUwyNS45MDA0IDMxLjQxNTZDMjYuMTAwMyAzMS4zMDE5IDI2LjI2NjMgMzEuMTM3IDI2LjM4MTMgMzAuOTM3OEMyNi40OTY0IDMwLjczODYgMjYuNTU2MyAzMC41MTI0IDI2LjU1NDkgMzAuMjgyNVYxOS4wNTQyTDI5LjkyMTMgMjAuOTk4QzI5LjkzODkgMjEuMDA2OCAyOS45NTQxIDIxLjAxOTggMjkuOTY1NiAyMS4wMzU5QzI5Ljk3NyAyMS4wNTIgMjkuOTg0MiAyMS4wNzA3IDI5Ljk4NjcgMjEuMDkwMlYzMC4zODg5QzI5Ljk4NDIgMzIuMzc1IDI5LjE5NDYgMzQuMjc5MSAyNy43OTA5IDM1LjY4NDFDMjYuMzg3MiAzNy4wODkyIDI0LjQ4MzggMzcuODgwNiAyMi40OTc4IDM3Ljg4NDlaTTYuMzkyMjcgMzEuMDA2NEM1LjUxMzk3IDI5LjQ4ODggNS4xOTc0MiAyNy43MTA3IDUuNDk4MDQgMjUuOTgzMkM1LjU1NzE4IDI2LjAxODcgNS42NjA0OCAyNi4wODE4IDUuNzM0NjEgMjYuMTI0NEwxMy42OTkgMzAuNzI0OEMxMy44OTc1IDMwLjg0MDggMTQuMTIzMyAzMC45MDIgMTQuMzUzMiAzMC45MDJDMTQuNTgzIDMwLjkwMiAxNC44MDg4IDMwLjg0MDggMTUuMDA3MyAzMC43MjQ4TDI0LjczMSAyNS4xMTAzVjI4Ljk5NzlDMjQuNzMyMSAyOS4wMTc3IDI0LjcyODMgMjkuMDM3NiAyNC43MTk5IDI5LjA1NTZDMjQuNzExNSAyOS4wNzM2IDI0LjY5ODggMjkuMDg5MyAyNC42ODI5IDI5LjEwMTJMMTYuNjMxNyAzMy43NDk3QzE0LjkwOTYgMzQuNzQxNiAxMi44NjQzIDM1LjAwOTcgMTAuOTQ0NyAzNC40OTU0QzkuMDI1MDYgMzMuOTgxMSA3LjM4Nzg1IDMyLjcyNjMgNi4zOTIyNyAzMS4wMDY0Wk00LjI5NzA3IDEzLjYxOTRDNS4xNzE1NiAxMi4wOTk4IDYuNTUyNzkgMTAuOTM2NCA4LjE5ODg1IDEwLjMzMjdDOC4xOTg4NSAxMC40MDEzIDguMTk0OTEgMTAuNTIyOCA4LjE5NDkxIDEwLjYwNzFWMTkuODA4QzguMTkzNTEgMjAuMDM3OCA4LjI1MzM0IDIwLjI2MzggOC4zNjgyMyAyMC40NjI5QzguNDgzMTIgMjAuNjYxOSA4LjY0ODkzIDIwLjgyNjcgOC44NDg2MyAyMC45NDA0TDE4LjU3MjMgMjYuNTU0MkwxNS4yMDYgMjguNDk3OUMxNS4xODk0IDI4LjUwODkgMTUuMTcwMyAyOC41MTU1IDE1LjE1MDUgMjguNTE3M0MxNS4xMzA3IDI4LjUxOTEgMTUuMTEwNyAyOC41MTYgMTUuMDkyNCAyOC41MDgyTDcuMDQwNDYgMjMuODU1N0M1LjMyMTM1IDIyLjg2MDEgNC4wNjcxNiAyMS4yMjM1IDMuNTUyODkgMTkuMzA0NkMzLjAzODYyIDE3LjM4NTggMy4zMDYyNCAxNS4zNDEzIDQuMjk3MDcgMTMuNjE5NFpNMzEuOTU1IDIwLjA1NTZMMjIuMjMxMiAxNC40NDExTDI1LjU5NzYgMTIuNDk4MUMyNS42MTQyIDEyLjQ4NzIgMjUuNjMzMyAxMi40ODA1IDI1LjY1MzEgMTIuNDc4N0MyNS42NzI5IDEyLjQ3NjkgMjUuNjkyOCAxMi40ODAxIDI1LjcxMTEgMTIuNDg3OUwzMy43NjMxIDE3LjEzNjRDMzQuOTk2NyAxNy44NDkgMzYuMDAxNyAxOC44OTgyIDM2LjY2MDYgMjAuMTYxM0MzNy4zMTk0IDIxLjQyNDQgMzcuNjA0NyAyMi44NDkgMzcuNDgzMiAyNC4yNjg0QzM3LjM2MTcgMjUuNjg3OCAzNi44MzgyIDI3LjA0MzIgMzUuOTc0MyAyOC4xNzU5QzM1LjExMDMgMjkuMzA4NiAzMy45NDE1IDMwLjE3MTcgMzIuNjA0NyAzMC42NjQxQzMyLjYwNDcgMzAuNTk0NyAzMi42MDQ3IDMwLjQ3MzMgMzIuNjA0NyAzMC4zODg5VjIxLjE4OEMzMi42MDY2IDIwLjk1ODYgMzIuNTQ3NCAyMC43MzI4IDMyLjQzMzIgMjAuNTMzOEMzMi4zMTkgMjAuMzM0OCAzMi4xNTQgMjAuMTY5OCAzMS45NTUgMjAuMDU1NlpNMzUuMzA1NSAxNS4wMTI4QzM1LjI0NjQgMTQuOTc2NSAzNS4xNDMxIDE0LjkxNDIgMzUuMDY5IDE0Ljg3MTdMMjcuMTA0NSAxMC4yNzEyQzI2LjkwNiAxMC4xNTU0IDI2LjY4MDMgMTAuMDk0MyAyNi40NTA0IDEwLjA5NDNDMjYuMjIwNiAxMC4wOTQzIDI1Ljk5NDggMTAuMTU1NCAyNS43OTYzIDEwLjI3MTJMMTYuMDcyNiAxNS44ODU4VjExLjk5ODJDMTYuMDcxNSAxMS45NzgzIDE2LjA3NTMgMTEuOTU4NSAxNi4wODM3IDExLjk0MDVDMTYuMDkyMSAxMS45MjI1IDE2LjEwNDggMTEuOTA2OCAxNi4xMjA3IDExLjg5NDlMMjQuMTcxOSA3LjI1MDI1QzI1LjQwNTMgNi41MzkwMyAyNi44MTU4IDYuMTkzNzYgMjguMjM4MyA2LjI1NDgyQzI5LjY2MDggNi4zMTU4OSAzMS4wMzY0IDYuNzgwNzcgMzIuMjA0NCA3LjU5NTA4QzMzLjM3MjMgOC40MDkzOSAzNC4yODQyIDkuNTM5NDUgMzQuODMzNCAxMC44NTMxQzM1LjM4MjYgMTIuMTY2NyAzNS41NDY0IDEzLjYwOTUgMzUuMzA1NSAxNS4wMTI4Wk0xNC4yNDI0IDIxLjk0MTlMMTAuODc1MiAxOS45OTgxQzEwLjg1NzYgMTkuOTg5MyAxMC44NDIzIDE5Ljk3NjMgMTAuODMwOSAxOS45NjAyQzEwLjgxOTUgMTkuOTQ0MSAxMC44MTIyIDE5LjkyNTQgMTAuODA5OCAxOS45MDU4VjEwLjYwNzFDMTAuODEwNyA5LjE4Mjk1IDExLjIxNzMgNy43ODg0OCAxMS45ODE5IDYuNTg2OTZDMTIuNzQ2NiA1LjM4NTQ0IDEzLjgzNzcgNC40MjY1OSAxNS4xMjc1IDMuODIyNjRDMTYuNDE3MyAzLjIxODY5IDE3Ljg1MjQgMi45OTQ2NCAxOS4yNjQ5IDMuMTc2N0MyMC42Nzc1IDMuMzU4NzYgMjIuMDA4OSAzLjkzOTQxIDIzLjEwMzQgNC44NTA2N0MyMy4wNDI3IDQuODgzNzkgMjIuOTM3IDQuOTQyMTUgMjIuODY2OCA0Ljk4NDczTDE0LjkwMjQgOS41ODUxN0MxNC43MDI1IDkuNjk4NzggMTQuNTM2NiA5Ljg2MzU2IDE0LjQyMTUgMTAuMDYyNkMxNC4zMDY1IDEwLjI2MTYgMTQuMjQ2NiAxMC40ODc3IDE0LjI0NzkgMTAuNzE3NUwxNC4yNDI0IDIxLjk0MTlaTTE2LjA3MSAxNy45OTkxTDIwLjQwMTggMTUuNDk3OEwyNC43MzI1IDE3Ljk5NzVWMjIuOTk4NUwyMC40MDE4IDI1LjQ5ODNMMTYuMDcxIDIyLjk5ODVWMTcuOTk5MVoiIGZpbGw9IndoaXRlIj48L3BhdGg+PC9zdmc+Jyk7Cgl9CgkKCS5iZy1ibGFjayB7CgkJYmFja2dyb3VuZDogIzAwMDsKCX0KCQoJLmJnLWdyYXktODAwIHsKCQliYWNrZ3JvdW5kOiByZ2JhKDUyLDUzLDY1KTsKCX0KCQoJLnRleHQtZ3JheS0yMDAgewoJCWNvbG9yOiByZ2JhKDIxNywyMTcsMjI3KTsKCX0KCQoJLnB5LTIgewoJCXBhZGRpbmctYm90dG9tOiAwLjVyZW07CgkJcGFkZGluZy10b3A6IDAuNXJlbTsKCX0KCS5weC00IHsKCQlwYWRkaW5nLWxlZnQ6IDFyZW07CgkJcGFkZGluZy1yaWdodDogMXJlbTsKCX0KCgkudGV4dC14cyB7CgkJZm9udC1zaXplOiAuNzVyZW07CgkJbGluZS1oZWlnaHQ6IDFyZW07Cgl9CgoJLmZvbnQtc2FucyB7CgkJZm9udC1mYW1pbHk6IFPDtmhuZSx1aS1zYW5zLXNlcmlmLHN5c3RlbS11aSwtYXBwbGUtc3lzdGVtLFNlZ29lIFVJLFJvYm90byxVYnVudHUsQ2FudGFyZWxsLE5vdG8gU2FucyxzYW5zLXNlcmlmLEhlbHZldGljYSBOZXVlLEFyaWFsLEFwcGxlIENvbG9yIEVtb2ppLFNlZ29lIFVJIEVtb2ppLFNlZ29lIFVJIFN5bWJvbCxOb3RvIENvbG9yIEVtb2ppOwoJfQoJCglbdHlwZT1idXR0b25dLCBbdHlwZT1yZXNldF0sIFt0eXBlPXN1Ym1pdF0sIGJ1dHRvbiB7CgkJZGlzcGxheTogbm9uZSAhaW1wb3J0YW50OwoJCS13ZWJraXQtYXBwZWFyYW5jZTogYnV0dG9uOwoJCWJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwoJCWJhY2tncm91bmQtaW1hZ2U6IG5vbmU7CgkJYm9yZGVyOiAwIHNvbGlkICNkOWQ5ZTM7CgkJYm94LXNpemluZzogYm9yZGVyLWJveDsKCQljb2xvcjogaW5oZXJpdDsKCX0KCQoJLmdhcC0yIHsKCQlnYXA6IDAuNXJlbTsKCX0KCQoJLnAtNCB7CgkJcGFkZGluZzogMXJlbTsKCX0KCQoJLmZsZXggewoJCWRpc3BsYXk6IGZsZXg7Cgl9CgkubWwtYXV0byB7CgkJbWFyZ2luLWxlZnQ6IGF1dG87Cgl9Cgk8L3N0eWxlPgoJPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KCS5obGpzLWNvbW1lbnR7CgkJY29sb3I6aHNsYSgwLDAlLDEwMCUsLjUpCgl9CgkuaGxqcy1tZXRhewoJCWNvbG9yOmhzbGEoMCwwJSwxMDAlLC42KQoJfQoJLmhsanMtYnVpbHRfaW4sLmhsanMtY2xhc3MgLmhsanMtdGl0bGV7CgkJY29sb3I6I2U5OTUwYwoJfQoJLmhsanMtZG9jdGFnLC5obGpzLWZvcm11bGEsLmhsanMta2V5d29yZCwuaGxqcy1saXRlcmFsewoJCWNvbG9yOiMyZTk1ZDMKCX0KCS5obGpzLWFkZGl0aW9uLC5obGpzLWF0dHJpYnV0ZSwuaGxqcy1tZXRhLXN0cmluZywuaGxqcy1yZWdleHAsLmhsanMtc3RyaW5newoJCWNvbG9yOiMwMGE2N2QKCX0KCS5obGpzLWF0dHIsLmhsanMtbnVtYmVyLC5obGpzLXNlbGVjdG9yLWF0dHIsLmhsanMtc2VsZWN0b3ItY2xhc3MsLmhsanMtc2VsZWN0b3ItcHNldWRvLC5obGpzLXRlbXBsYXRlLXZhcmlhYmxlLC5obGpzLXR5cGUsLmhsanMtdmFyaWFibGV7CgkJY29sb3I6I2RmMzA3OQoJfQoJLmhsanMtYnVsbGV0LC5obGpzLWxpbmssLmhsanMtc2VsZWN0b3ItaWQsLmhsanMtc3ltYm9sLC5obGpzLXRpdGxlewoJCWNvbG9yOiNmMjJjM2QKCX0KCS50b2tlbi5jZGF0YSwudG9rZW4uY29tbWVudCwudG9rZW4uZG9jdHlwZSwudG9rZW4ucHJvbG9newoJCWNvbG9yOiNhOWFlYzEKCX0KCS50b2tlbi5wdW5jdHVhdGlvbnsKCQljb2xvcjojZmVmZWZlCgl9CgkudG9rZW4uY29uc3RhbnQsLnRva2VuLmRlbGV0ZWQsLnRva2VuLnByb3BlcnR5LC50b2tlbi5zeW1ib2wsLnRva2VuLnRhZ3sKCQljb2xvcjojZmZhMDdhCgl9CgkudG9rZW4uYm9vbGVhbiwudG9rZW4ubnVtYmVyewoJCWNvbG9yOiMwMGUwZTAKCX0KCS50b2tlbi5hdHRyLW5hbWUsLnRva2VuLmJ1aWx0aW4sLnRva2VuLmNoYXIsLnRva2VuLmluc2VydGVkLC50b2tlbi5zZWxlY3RvciwudG9rZW4uc3RyaW5newoJCWNvbG9yOiNhYmUzMzgKCX0KCS5sYW5ndWFnZS1jc3MgLnRva2VuLnN0cmluZywuc3R5bGUgLnRva2VuLnN0cmluZywudG9rZW4uZW50aXR5LC50b2tlbi5vcGVyYXRvciwudG9rZW4udXJsLC50b2tlbi52YXJpYWJsZXsKCQljb2xvcjojMDBlMGUwCgl9CgkudG9rZW4uYXRydWxlLC50b2tlbi5hdHRyLXZhbHVlLC50b2tlbi5mdW5jdGlvbnsKCQljb2xvcjpnb2xkCgl9CgkudG9rZW4ua2V5d29yZHsKCQljb2xvcjojMDBlMGUwCgl9CgkudG9rZW4uaW1wb3J0YW50LC50b2tlbi5yZWdleHsKCQljb2xvcjpnb2xkCgl9CgkudG9rZW4uYm9sZCwudG9rZW4uaW1wb3J0YW50ewoJCWZvbnQtd2VpZ2h0OjcwMAoJfQoJLnRva2VuLml0YWxpY3sKCQlmb250LXN0eWxlOml0YWxpYwoJfQoJLnRva2VuLmVudGl0eXsKCQljdXJzb3I6aGVscAoJfQoJQG1lZGlhIHNjcmVlbiBhbmQgKC1tcy1oaWdoLWNvbnRyYXN0OmFjdGl2ZSl7CgkJY29kZVtjbGFzcyo9bGFuZ3VhZ2UtXSxwcmVbY2xhc3MqPWxhbmd1YWdlLV17CgkJCWJhY2tncm91bmQ6d2luZG93OwoJCQljb2xvcjp3aW5kb3dUZXh0CgkJfQoJCTpub3QocHJlKT5jb2RlW2NsYXNzKj1sYW5ndWFnZS1dLHByZVtjbGFzcyo9bGFuZ3VhZ2UtXXsKCQkJYmFja2dyb3VuZDp3aW5kb3cKCQl9CgkJLnRva2VuLmltcG9ydGFudHsKCQkJYmFja2dyb3VuZDpoaWdobGlnaHQ7CgkJCWNvbG9yOndpbmRvdzsKCQkJZm9udC13ZWlnaHQ6NDAwCgkJfQoJCS50b2tlbi5hdHJ1bGUsLnRva2VuLmF0dHItdmFsdWUsLnRva2VuLmZ1bmN0aW9uLC50b2tlbi5rZXl3b3JkLC50b2tlbi5vcGVyYXRvciwudG9rZW4uc2VsZWN0b3J7CgkJCWZvbnQtd2VpZ2h0OjcwMAoJCX0KCQkudG9rZW4uYXR0ci12YWx1ZSwudG9rZW4uY29tbWVudCwudG9rZW4uZG9jdHlwZSwudG9rZW4uZnVuY3Rpb24sLnRva2VuLmtleXdvcmQsLnRva2VuLm9wZXJhdG9yLC50b2tlbi5wcm9wZXJ0eSwudG9rZW4uc3RyaW5newoJCQljb2xvcjpoaWdobGlnaHQKCQl9CgkJLnRva2VuLmF0dHItdmFsdWUsLnRva2VuLnVybHsKCQkJZm9udC13ZWlnaHQ6NDAwCgkJfQoJfQoJPC9zdHlsZT4KICA8L2hlYWQ+CiAgPGJvZHk+Cgk8ZGl2IGNsYXNzPSJyZXBsaWVzIj4KCQk8IS0tIElOU0VSVCBIRVJFIC0tPgoJPC9kaXY+CiAgPC9ib2R5Pgo8L2h0bWw+`);
    const HTML_MARKER = `<!-- INSERT HERE -->`;

	async function sha1Hash(stringToHash) {
		const encoder = new TextEncoder();
		const dataToHash = encoder.encode(stringToHash);

		const crypto = window.crypto || window.msCrypto; // for IE 11
		const subtle = crypto.subtle;
		const hashAlgorithm = "SHA-1";

		const hashedData = await subtle.digest(hashAlgorithm, dataToHash);

		// Convert the hashed data to a hexadecimal string
		const hashedHexString = Array.from(new Uint8Array(hashedData))
			.map((b) => b.toString(16).padStart(2, "0"))
			.join("");

		return hashedHexString;
	}

	function makeHTML(contents) {
		return HTML_TEMPLATE.replace(HTML_MARKER, contents);
	}

    // replace videos
    const callback = function(mutationsList, observer) {
		const nav = document.querySelector("nav");

        if(Array.from(nav.querySelectorAll("#custom_save_button")).length > 0)
            return;

		const el = nav.lastElementChild.cloneNode(false);
        el.id = 'custom_save_button';
		el.innerHTML = "Save Chat";

		el.onclick = async function() {
			const a = document.createElement('a');
			const contents = Array.from(document.querySelectorAll(".text-base")).map(
				item => {
                    const isGPT = Array.from(item.querySelectorAll('button')).length >= 2;
					//const isGPT = item.querySelector(`div[class^="request-"]`) !== null
					const contents = item.querySelector(`.items-start`)

					if(contents === null) {
						return null;
                    }

					return `<div class="${isGPT ? "gpt" : "user"}">${contents.innerHTML}</div>`
				}
			);

			for(const item of contents) {
				if(item === null) {
					alert("Failed to get text for all items, check your CSS selector :(");
					return;
				}
			}

			a.href = URL.createObjectURL(new Blob([makeHTML(contents.join("\n"))], {
				type: 'text/html'
			}));
            const hash = await sha1Hash(contents[0]);
			a.download = `gpt_${hash}.html`;
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(a.href);
		}

		nav.appendChild(el);
    };

    window.addEventListener('load', (event) => {
        const observer = new MutationObserver(callback);
        observer.observe(document.querySelector('body'), { attributes: true, childList: true, subtree: true });
    });
})();
